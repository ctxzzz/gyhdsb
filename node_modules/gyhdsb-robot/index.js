const cron = require('node-cron');
const axios = require('axios');
const lunarCalendar = require('lunar-calendar');

class GYHDSB {
  constructor(config) {
    this.config = config;
    this.locations = config.locations;
    this.qweatherKey = config.qweatherKey;
    this.webhookUrl = config.webhookUrl;
    this.cron = config.cron;
    this.result = [];
  }
  run() {
    const crontab = this.cron || '0 8 * * *';
    cron.schedule(crontab, this.dailyTask);
  }
  test() {
    this.dailyTask()
  }
  dailyTask() {
    const contentArr = [];
    const date = new Date();
    const today = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
    this.#processArray(this.locations).then(() => {
      this.result.forEach((item) => {
        contentArr.push(`
ğŸ“${item.name}:
   Â· ä»Šæ—¥æ°”æ¸©${item.tempMin} ~ ${item.tempMax}â„ƒ ${item.textDay} 
   . æ—¥å‡º ${item.sunrise} æ—¥è½ ${item.sunset}
   Â· ä»Šæ—¥é£å†µ ${item.windDirDay} ${item.windScaleDay}çº§
           [ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…](https://www.qweather.com/weather/${item.name}-${item.location}.html)  



                         ${today}
                       å†œå†${item.lunarDate.lunarMonthName} ${item.lunarDate.lunarDayName} `)
      })
      
      const content = `
        Dear allğŸ˜˜
  
  
        ${contentArr.join('\n\n\n')}
  
        @æ‰€æœ‰äºº 
      `
  
      axios.post(this.webhookUrl, {
        msgtype: 'markdown',
        markdown: {
          content
        },
      });
    });
  }

  async #processArray(array) {
    for (let item of array) {
      await this.#processItem(item);
    }
  }

  async #processItem(item) {
    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚ä¸€ä¸ª API è¯·æ±‚
    return new Promise((resolve) =>
      axios
        .get(
          `https://devapi.qweather.com/v7/weather/3d?location=${item.location}&key=${this.qweatherKey}`
        )
        .then((res) => {
          const data = res.data.daily[0];
          // å‡è®¾æœ‰ä¸¤ä¸ªæ—¥æœŸå­—ç¬¦ä¸²
          const date = new Date();
          data.name = item.name;
          data.location = item.location;
          data.lunarDate = lunarCalendar.solarToLunar(
            date.getFullYear(),
            date.getMonth() + 1,
            date.getDate()
          );
          this.result.push(data);
          resolve();
          
        })
    );
  }
}

module.exports = GYHDSB;
